<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article</title>
    <style>
        body { font-family: serif; line-height: 1.8; max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        h1 { color: #002244; border-bottom: 4px solid #e63946; }
        .lang-switch { text-align: right; margin-bottom: 20px; }
        .content { font-size: 1.2rem; margin-bottom: 40px; }
        .proverb-section { background: #f0f4f8; padding: 20px; border-left: 8px solid #002244; }
        .term-hl { border-bottom: 2px dotted #e63946; cursor: pointer; font-weight: bold; }
        #popup { position: fixed; bottom: -150px; left: 0; width: 100%; background: #002244; color: white; padding: 25px; transition: 0.4s; box-sizing: border-box; z-index: 1000; text-align: center; }
        #popup.active { bottom: 0; }
        .en, .jp { display: none; }
        .help-text { font-size: 0.7rem; color: #ccc; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="lang-switch"><button onclick="toggleLang()">EN / JP</button></div>
    
    <article>
        <h1 class="jp">{{ item.title_jp }}</h1><h1 class="en">{{ item.title_en }}</h1>
        <p>{{ item.date }}</p>

        <div class="content jp" id="content-jp">{{ item.content_jp | replace('\n', '<br>') }}</div>
        <div class="content en" id="content-en">{{ item.content_en | replace('\n', '<br>') }}</div>

        <div class="proverb-section">
            <h3 class="jp">今日のことわざ: {{ item.proverb.title_jp }}</h3>
            <h3 class="en">Today's Proverb: {{ item.proverb.title_en }}</h3>
            <p class="jp">{{ item.proverb.desc_jp }}</p>
            <p class="en">{{ item.proverb.desc_en }}</p>
        </div>
    </article>

    <div id="popup">
        <strong id="p-term"></strong>: <span id="p-def"></span>
        <div class="help-text">Tap to close | クリックで閉じる</div>
    </div>

    <script>
        const glossary = {{ item.glossary | tojson }};
        let lang = localStorage.getItem('lang') || 'jp';

        function toggleLang() {
            lang = lang === 'jp' ? 'en' : 'jp';
            localStorage.setItem('lang', lang);
            location.reload();
        }

        function showPopup(term, def) {
            document.getElementById('p-term').innerText = term;
            document.getElementById('p-def').innerText = def;
            const popup = document.getElementById('popup');
            popup.classList.add('active');
            popup.onclick = () => popup.classList.remove('active');
            setTimeout(() => popup.classList.remove('active'), 8000);
        }

        // 用語ハイライト処理
        ['jp', 'en'].forEach(l => {
            const container = document.getElementById('content-' + l);
            let html = container.innerHTML;
            glossary.forEach(g => {
                const term = l === 'jp' ? g.term_jp : g.term_en;
                const def = l === 'jp' ? g.def_jp : g.def_en;
                const regex = new RegExp(term, 'g');
                html = html.replace(regex, `<span class="term-hl" data-term="${term}" data-def="${def}">${term}</span>`);
            });
            container.innerHTML = html;
        });

        // 言語表示切り替え
        document.querySelectorAll('.' + lang).forEach(el => el.style.display = 'block');

        // イベント付与（クリック＆長押し）
        document.querySelectorAll('.term-hl').forEach(el => {
            let timer;
            const term = el.dataset.term;
            const def = el.dataset.def;

            el.onclick = () => showPopup(term, def); // PCクリック

            // スマホ長押し
            el.ontouchstart = () => { timer = setTimeout(() => showPopup(term, def), 800); };
            el.ontouchend = () => { clearTimeout(timer); };
        });
    </script>
</body>
</html>
